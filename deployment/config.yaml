- hosts: homeassistant
  vars:
    ha_base_url: "https://home.newtonho.me"
    ha_api_url: "{{ ha_base_url }}/api"

  pre_tasks:
    - name: read home assistant api token
      command: op read "op://jxs6qrivegu7ekpzkt27seurvy/fgvzkd432x4xsjq7f3vu4zippu/password"
      delegate_to: localhost
      run_once: true
      register: ha_api_token_cmd
      changed_when: false
      no_log: true

    - name: cache home assistant api token
      set_fact:
        ha_api_token: "{{ ha_api_token_cmd.stdout }}"
      no_log: true

  handlers:
    # n.b. Play-level handlers are callable from roles included by the play.

    # Reload architecture:
    # - Use Home Assistant reload services for file-level changes where possible.
    # - Reserve full restarts for custom_components and config that cannot reload.
    # - Reload calls go via the HA API using the 1Password token.
    - name: reload core config
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/homeassistant/reload_core_config"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload automations
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/automation/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload scripts
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/script/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload templates
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/template/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload groups
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/group/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload input numbers
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/input_number/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload input texts
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/input_text/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload input selects
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/input_select/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload input booleans
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/input_boolean/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload input datetimes
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/input_datetime/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json
      no_log: true

    - name: reload pyscript
      ansible.builtin.uri:
        url: "{{ ha_api_url }}/services/pyscript/reload"
        method: POST
        headers:
          Authorization: "Bearer {{ ha_api_token }}"
          Content-Type: "application/json"
        body: {}
        body_format: json

    # Restart Home Assistant. This is required for reloading custom_components and a
    # heavy-handed fallback for config that cannot reload.
    - name: restart ha
      command: ha core restart

  roles:
    - role: custom_component
      vars:
        component_name: HACS
        component_full_name: hacs/integration
        component_domain: hacs
        component_version: "2.0.5"

    - role: custom_component
      vars:
        component_name: Local Tuya
        component_full_name: rospogrigio/localtuya
        component_domain: localtuya
        component_version: "v5.2.4"

    - role: custom_component
      vars:
        component_name: Octopus Energy
        component_full_name: BottlecapDave/HomeAssistant-OctopusEnergy
        component_domain: octopus_energy
        component_version: "v17.1.1"

    - role: custom_component
      vars:
        component_name: Pirate Weather
        component_full_name: Pirate-Weather/pirate-weather-ha
        component_domain: pirateweather
        component_version: "v1.8.3"

    - role: custom_component
      vars:
        component_name: ZHA Toolkit
        component_full_name: mdeweerd/zha-toolkit
        component_domain: zha_toolkit
        component_version: "v1.1.33"

    - role: custom_component
      vars:
        component_name: Anglian Water
        component_full_name: pantherale0/haanglianwater
        component_domain: anglian_water
        component_version: "2025.10.0"

    - role: custom_component
      vars:
        component_name: Waste Collection Schedule
        component_full_name: mampfes/hacs_waste_collection_schedule
        component_domain: waste_collection_schedule
        component_version: "2.8.0"

    - role: custom_component
      vars:
        component_name: Pyscript
        component_full_name: custom-components/pyscript
        component_domain: pyscript
        component_version: "1.7.0"

  tasks:
    - name: create zigpy ota directory
      file:
        state: directory
        path: "{{ zigpy_ota_dir }}"

    - name: install zha configuration
      template:
        src: zha.yaml.j2
        dest: "{{ ha_config_dir }}/zha.yaml"
      notify: restart ha

    - name: install alert configuration
      ansible.builtin.synchronize:
        src: alerts
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/alerts/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload core config

    - name: install automation configuration
      ansible.builtin.synchronize:
        src: automations
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/automations/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload automations

    - name: install script configuration
      ansible.builtin.synchronize:
        src: scripts
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload scripts

    - name: install sensor configuration
      ansible.builtin.synchronize:
        src: sensors
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/sensors/.rsync-filter"
          - "--exclude=.rsync-filter"
      # Sensor YAML reloads via core config, but some integrations may still need restart.
      notify: reload core config

    - name: install group configuration
      ansible.builtin.synchronize:
        src: groups
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload groups

    - name: install template configuration
      ansible.builtin.synchronize:
        src: templates
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/templates/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload templates

    - name: install notify configuration
      ansible.builtin.synchronize:
        src: notify
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload core config

    - name: install rest configuration
      ansible.builtin.synchronize:
        src: rest
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/rest/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload core config

    - name: install command line configuration
      ansible.builtin.synchronize:
        src: command_line
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/command_line/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload core config

    - name: install input number configuration
      ansible.builtin.synchronize:
        src: input_numbers
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload input numbers

    - name: install input text configuration
      ansible.builtin.synchronize:
        src: input_texts
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload input texts

    - name: install input select configuration
      ansible.builtin.synchronize:
        src: input_selects
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload input selects

    - name: install input boolean configuration
      ansible.builtin.synchronize:
        src: input_booleans
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload input booleans

    - name: install input datetime configuration
      ansible.builtin.synchronize:
        src: input_datetimes
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
      notify: reload input datetimes

    - name: install pyscript configuration
      ansible.builtin.synchronize:
        src: pyscript
        dest: "{{ ha_config_dir }}"
        recursive: yes
        delete: yes
        links: yes
        rsync_opts:
          - "--filter=merge\\ {{ playbook_dir }}/files/pyscript/.rsync-filter"
          - "--exclude=.rsync-filter"
      notify: reload pyscript

    - name: install configuration
      copy:
        src: configuration.yaml
        dest: "{{ ha_config_dir }}/configuration.yaml"
      # Keep this file static and push most changes into includes for targeted reloads.
      notify: reload core config

    - name: install frontend configuration
      copy:
        src: frontend.yaml
        dest: "{{ ha_config_dir }}/frontend.yaml"

    - name: install waste collection schedule configuration
      copy:
        src: waste_collection_schedule.yaml
        dest: "{{ ha_config_dir }}/waste_collection_schedule.yaml"
      notify: restart ha

    - name: install http configuration
      copy:
        src: http.yaml
        dest: "{{ ha_config_dir }}/http.yaml"
      notify: restart ha

    - name: install templated automations
      template:
        src: "automations/{{ item }}.yaml.j2"
        dest: "{{ ha_config_dir }}/automations/{{ item }}.yaml"
      notify: reload automations
      loop:
        - family_room_lamp_mode_energy
        - landing_thermostat_radiator_call_for_heat
        - radiator_external_temperature
        - radiator_follow_thermostat
        - washing_machine_schedule

    - name: install templated sensors
      template:
        src: "sensors/{{ item }}.yaml.j2"
        dest: "{{ ha_config_dir }}/sensors/{{ item }}.yaml"
      notify: reload core config
      loop:
        - worxlandroid
        - octopus_energy_electricity_export_current_accumulative_consumption

    - name: install templated localtuya socket sensors
      template:
        src: "sensors/localtuya_socket_energy.yaml.j2"
        dest: "{{ ha_config_dir }}/sensors/{{ item.name }}.yaml"
      vars:
        name: "{{ item.name }}"
        source: "{{ item.source }}"
      notify: reload core config
      loop:
        - name: connors_desk_socket_energy
          source: sensor.connors_desk_socket_power
        - name: kettle_socket_energy
          source: sensor.kettle_socket_power
        - name: dishwasher_socket_energy
          source: sensor.dishwasher_socket_power
        - name: fridge_socket_energy
          source: sensor.fridge_socket_power

    - name: install templated templates
      template:
        src: "templates/{{ item }}.yaml.j2"
        dest: "{{ ha_config_dir }}/templates/{{ item }}.yaml"
      notify: reload templates
      loop:
        - covers_battery_low
        - octopus_energy_electricity_current_export

    - name: install templated localtuya socket templates
      template:
        src: "templates/localtuya_socket_power.yaml.j2"
        dest: "{{ ha_config_dir }}/templates/{{ item.file }}.yaml"
      vars:
        name: "{{ item.name }}"
        unique_id: "{{ item.unique_id }}"
        switch: "{{ item.switch }}"
      notify: reload templates
      loop:
        - file: connors_desk_socket_power
          name: Connors Desk Socket Power
          unique_id: connors_desk_socket_power
          switch: connors_desk_socket
        - file: kettle_socket_power
          name: Kettle Socket Power
          unique_id: kettle_socket_power
          switch: kettle_socket
        - file: dishwasher_socket_power
          name: Dishwasher Socket Power
          unique_id: dishwasher_socket_power
          switch: dishwasher_socket
        - file: fridge_socket_power
          name: Fridge Socket Power
          unique_id: fridge_socket_power
          switch: fridge_socket

    - name: install templated pyscript
      template:
        src: "pyscript/{{ item.src }}"
        dest: "{{ item.dest }}"
      notify: reload pyscript
      loop:
        - src: "modules/washing_machine_constants.py.j2"
          dest: "{{ ha_config_dir }}/pyscript/modules/washing_machine_constants.py"


    - name: install templated alerts
      template:
        src: "alerts/{{ item }}.yaml.j2"
        dest: "{{ ha_config_dir }}/alerts/{{ item }}.yaml"
      notify: reload core config
      loop:
        - covers_battery_low
