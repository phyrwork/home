- id: car_battery_sync_percent_to_energy
  alias: Car Battery Sync Percent To Energy
  description: Keep kWh helpers in sync when % or capacity changes
  trigger:
    - platform: state
      entity_id:
        - sensor.car_battery_level
        - input_number.car_battery_level_target
        - input_number.car_battery_energy_capacity
  action:
    - variables:
        capacity: "{{ states('input_number.car_battery_energy_capacity') | float(0) }}"
        level_current: "{{ states('sensor.car_battery_level') | float(0) }}"
        level_target: "{{ states('input_number.car_battery_level_target') | float(0) }}"
        energy_target: "{{ (capacity * level_target / 100) | round(3) }}"
    - service: input_number.set_value
      target:
        entity_id: input_number.car_battery_energy_target
      data:
        value: "{{ energy_target }}"
  mode: single

- id: car_battery_stop_charge_at_target
  alias: Car Battery Stop Charge At Target
  description: Stop the charger when target energy is reached
  trigger:
    - platform: state
      entity_id:
        - sensor.car_battery_energy_current
        - input_number.car_battery_energy_target
  condition:
    - condition: template
      value_template: >-
        {% set current = states('sensor.car_battery_energy_current') | float(0) %}
        {% set target = states('input_number.car_battery_energy_target') | float(0) %}
        {{ current >= target }}
  action:
    - service: homeassistant.turn_off
      target:
        entity_id: switch.ev_charger
  mode: single

- id: car_battery_start_charge_at_best_time
  alias: Car Battery Start Charge At Best Time
  description: Start the EV charger at the cheapest start time
  trigger:
    - platform: state
      entity_id: sensor.car_battery_target_cost_next_lowest_start_cost_time
    - platform: time_pattern
      minutes: "/1"
  condition:
    - condition: state
      entity_id: switch.ev_charger
      state: "off"
    - condition: template
      value_template: >-
        {% set needed = states('sensor.car_battery_energy_needed') | float(0) %}
        {{ needed > 0 }}
    # Avoid daytime starts unless tomorrow's rates are published; Octopus releases them ~16:00.
    - condition: template
      value_template: >-
        {% set now_local = now() %}
        {% if now_local.hour >= 8 and now_local.hour < 17 %}
          {% set rates_raw = state_attr('sensor.octopus_energy_electricity_21l4421345_2700007165105_fused_day_rates', 'rates') %}
          {% if rates_raw is string %}
            {% set rates = rates_raw | from_json %}
          {% else %}
            {% set rates = rates_raw | default([], true) %}
          {% endif %}
          {% set ends = rates | map(attribute='end') | list %}
          {% set latest_end = ends | max if ends else none %}
          {% if latest_end %}
            {{ as_datetime(latest_end).date() > now_local.date() }}
          {% else %}
            false
          {% endif %}
        {% else %}
          true
        {% endif %}
    - condition: template
      value_template: >-
        {% set start_time = states('sensor.car_battery_target_cost_next_lowest_start_cost_time') %}
        {% if start_time in ['unknown', 'unavailable', 'none', ''] %}
          false
        {% else %}
          {{ now() >= as_datetime(start_time) }}
        {% endif %}
  action:
    - service: homeassistant.turn_on
      target:
        entity_id: switch.ev_charger
  mode: single

# Fallback: ensure we still use the 23:30-05:30 off-peak window even if the
# scheduler can't find a valid start time for the defined window.
- id: car_battery_start_charge_fallback_off_peak
  alias: Car Battery Start Charge Fallback Off Peak
  description: Start charging at 23:30 if no next start time is available
  trigger:
    - platform: time
      at: "23:30:00"
  condition:
    - condition: state
      entity_id: switch.ev_charger
      state: "off"
    - condition: template
      value_template: >-
        {% set needed = states('sensor.car_battery_energy_needed') | float(0) %}
        {{ needed > 0 }}
    - condition: template
      value_template: >-
        {% set start_time = states('sensor.car_battery_target_cost_next_lowest_start_cost_time') %}
        {{ start_time in ['unknown', 'unavailable', 'none', ''] }}
  action:
    - service: homeassistant.turn_on
      target:
        entity_id: switch.ev_charger
  mode: single

- id: car_battery_stop_charge_at_off_peak_end
  alias: Car Battery Stop Charge At Off Peak End
  description: Stop charging at 05:30 even if target is not reached
  trigger:
    - platform: time
      at: "05:30:00"
  condition:
    - condition: state
      entity_id: switch.ev_charger
      state: "on"
  action:
    - service: homeassistant.turn_off
      target:
        entity_id: switch.ev_charger
  mode: single
