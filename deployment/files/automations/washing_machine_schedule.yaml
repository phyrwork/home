- id: washing_machine_start_when_optimal
  alias: Washing Machine Start When Optimal
  description: Start the washing machine at the best time before the deadline
  trigger:
    # "Latest start time" is the cheapest time to start to finish after the "finish after" time
    - platform: time
      at: sensor.washing_machine_cost_latest_start_time
    - platform: state
      entity_id: binary_sensor.washing_machine_remote_control
      to: "on"
  condition:
    - condition: state
      entity_id: binary_sensor.washing_machine_remote_control
      state: "on"
    - condition: template
      value_template: >-
        {{ states('select.washing_machine') != 'run' }}
    - condition: template
      value_template: >-
        {% set latest = as_datetime(states('sensor.washing_machine_cost_latest_start_time')) %}
        {{ latest is not none and now() >= latest }}
  action:
    - service: select.select_option
      target:
        entity_id: select.washing_machine
      data:
        option: run
  mode: single
