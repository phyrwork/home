- id: washing_machine_start_when_optimal
  alias: Washing Machine Start When Optimal
  description: Start the washing machine at the best time before the deadline
  trigger:
    - platform: state
      entity_id:
        - sensor.washing_machine_cost_start_later_costs
    - platform: state
      entity_id: binary_sensor.washing_machine_remote_control
      to: "on"
    - platform: time_pattern
      minutes: "/1"
      # Ensures we can act when best_start_time is reached without relying on other state changes.
  condition:
    - condition: state
      entity_id: binary_sensor.washing_machine_remote_control
      state: "on"
    - condition: template
      value_template: >-
        {% raw %}
        {{ states('select.washing_machine') != 'run' }}
        {% endraw %}
    - condition: template
      value_template: >-
        {% raw %}
        {% set costs = state_attr('sensor.washing_machine_cost_start_later_costs', 'costs') | default([], true) %}
        {% set ns = namespace(best=None) %}
        {% for item in costs %}
          {% set finish = as_datetime(item.finish) %}
          {% if finish %}
            {% set finish_hour = finish.hour %}
            {% if finish_hour >= 8 and finish_hour < 21 %}
              {% if ns.best is none or item.cost < ns.best.cost %}
                {% set ns.best = item %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {% if ns.best is none %}
          false
        {% else %}
          {{ now() >= as_datetime(ns.best.start) }}
        {% endif %}
        {% endraw %}
  action:
    - service: select.select_option
      target:
        entity_id: select.washing_machine
      data:
        option: run
  mode: single
