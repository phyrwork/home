- id: washing_machine_costing_update
  alias: Washing Machine Costing Update
  description: Update washing machine cost sensors when prices or inputs change
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.washing_machine_remote_control
        - select.washing_machine
        - sensor.current_export_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_export }}
        - sensor.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_current_rate
        - sensor.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_export }}_export_current_rate
        - event.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_current_day_rates
        - event.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_next_day_rates
  action:
    - service: pyscript.washing_machine_costing
  mode: single

- id: dishwasher_costing_update
  alias: Dishwasher Costing Update
  description: Update dishwasher cost sensors when prices or inputs change
  trigger:
    - platform: state
      entity_id:
        - sensor.current_export_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_export }}
        - sensor.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_current_rate
        - sensor.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_export }}_export_current_rate
        - event.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_current_day_rates
        - event.octopus_energy_electricity_{{ electricity_meter_serial_number | lower }}_{{ electricity_meter_mpan_import }}_next_day_rates
  action:
    - service: pyscript.dishwasher_costing
  mode: single

- id: washing_machine_start_when_optimal
  alias: Washing Machine Start When Optimal
  description: Start the washing machine at the best time before the deadline
  trigger:
    - platform: state
      entity_id:
        - sensor.washing_machine_best_start_time
    - platform: state
      entity_id: binary_sensor.washing_machine_remote_control
      to: "on"
    - platform: time_pattern
      minutes: "/1"
      # Ensures we can act when best_start_time is reached without relying on other state changes.
  condition:
    - condition: state
      entity_id: binary_sensor.washing_machine_remote_control
      state: "on"
    - condition: template
      value_template: >-
        {% raw %}
        {{ states('select.washing_machine') != 'run' }}
        {% endraw %}
    - condition: template
      value_template: >-
        {% raw %}
        {% set best = states('sensor.washing_machine_best_start_time') %}
        {% set latest = state_attr('sensor.washing_machine_best_start_time', 'latest_start') %}
        {% if best in ['unknown', 'unavailable', ''] or latest in ['unknown', 'unavailable', None, ''] %}
          false
        {% else %}
          {{ now() >= as_datetime(best) or now() >= as_datetime(latest) }}
        {% endif %}
        {% endraw %}
  action:
    - service: select.select_option
      target:
        entity_id: select.washing_machine
      data:
        option: run
  mode: single
