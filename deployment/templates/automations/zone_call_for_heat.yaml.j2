{% set ha_start = '{{' %}
{% set ha_end = '}}' %}
{% set call_for_heat_setpoint = 30 %}
{% set call_for_heat_lower_bound = call_for_heat_setpoint - 0.01 %}
{% set call_for_heat_delta = 0.1 %}

# Baseline tracks the Landing setpoint whenever call-for-heat is inactive.
- id: zone_call_for_heat_baseline
  alias: Zone call for heat baseline
  trigger:
    - platform: state
      entity_id: climate.landing
      attribute: temperature
  condition:
    - condition: template
      value_template: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) < {{ call_for_heat_lower_bound }} {{ ha_end }}"
  action:
    - service: input_number.set_value
      target:
        entity_id: input_number.landing_thermostat_baseline
      data:
        value: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) {{ ha_end }}"
  mode: single

# Start call-for-heat when central boiler requests heat.
- id: zone_call_for_heat_start
  alias: Zone call for heat start
  trigger:
    - platform: state
      entity_id: binary_sensor.landing_zone_configuration_central_boiler
      to: "on"
  condition:
    - condition: template
      value_template: "{{ ha_start }} state_attr('climate.landing', 'preset_mode') != 'eco' {{ ha_end }}"
    - condition: template
      value_template: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) < {{ call_for_heat_lower_bound }} {{ ha_end }}"
  action:
    - variables:
        baseline: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) {{ ha_end }}"
        call_target: {{ call_for_heat_setpoint }}
    - service: input_number.set_value
      target:
        entity_id: input_number.landing_thermostat_baseline
      data:
        value: "{{ ha_start }} baseline {{ ha_end }}"
    - service: climate.set_temperature
      target:
        entity_id: climate.landing
      data:
        temperature: "{{ ha_start }} call_target {{ ha_end }}"
  mode: single

# Stop call-for-heat when central boiler no longer requests heat or Nest is in eco.
- id: zone_call_for_heat_stop
  alias: Zone call for heat stop
  trigger:
    - platform: state
      entity_id: binary_sensor.landing_zone_configuration_central_boiler
      to: "off"
    - platform: template
      value_template: >
        {{ ha_start }}
        state_attr('climate.landing', 'preset_mode') == 'eco'
        {{ ha_end }}
  condition:
    - condition: template
      value_template: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) >= {{ call_for_heat_lower_bound }} {{ ha_end }}"
  action:
    - variables:
        baseline: "{{ ha_start }} states('input_number.landing_thermostat_baseline') | float(0) {{ ha_end }}"
        current_target: "{{ ha_start }} state_attr('climate.landing', 'temperature') | float(0) {{ ha_end }}"
    - choose:
        # Only restore if we still own the setpoint (Landing is still at our call target).
        - conditions:
            - condition: template
              value_template: >
                {{ ha_start }}
                state_attr('climate.landing', 'preset_mode') != 'eco'
                and (current_target - {{ call_for_heat_setpoint }}) | abs <= 0.1
                {{ ha_end }}
          sequence:
            - service: climate.set_temperature
              target:
                entity_id: climate.landing
              data:
                temperature: "{{ ha_start }} baseline {{ ha_end }}"
  mode: single
